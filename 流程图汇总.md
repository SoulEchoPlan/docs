## 1.完整架构图
graph TB
     subgraph 客户端层
         A[用户浏览器<br/>Frontend App]
         A1[UI渲染层<br/>React/Vue]
         A2[音频采集层<br/>MediaDevices API]
         A3[WebSocket客户端<br/>实时通信]
         A4[文件上传组件<br/>知识库管理]
     end

     subgraph Web接入层
         B[后端应用服务<br/>Spring Boot 3.2.8]
         B1[REST Controllers]
         B1_1[CharacterController<br/>角色管理API]
         B1_2[KnowledgeController<br/>知识库API]
         B2[WebSocket Handler<br/>ChatWebSocketHandler]
     end

     subgraph 核心业务层
         C[服务编排层]
         C1[RealtimeChatService<br/>实时对话编排]
         C2[CharacterService<br/>角色业务逻辑]
         C3[KnowledgeService<br/>知识库管理]
     end

     subgraph 事件驱动层
         F[异步处理框架]
         F1[KnowledgeUploadEvent<br/>上传事件]
         F2[KnowledgeUploadListener<br/>异步监听器]
     end

     subgraph AI能力层
         D[阿里云AI服务]
         D1[ASR<br/>实时语音识别]
         D2[LLM<br/>通义千问大模型]
         D3[TTS<br/>语音合成]
         D4[百炼知识库<br/>RAG检索增强]
     end

     subgraph 数据持久层
         E[(数据存储)]
         E1[(MySQL数据库)]
         E1_1[Characters表<br/>角色定义]
         E1_2[Sessions表<br/>会话记录]
         E1_3[KnowledgeBase表<br/>知识库文档]
         E2[(Redis缓存)]
         E2_1[对话历史缓存<br/>最多20条]
         E2_2[分布式锁<br/>Redisson]
     end

     subgraph 文件存储层
         G[文件存储系统]
         G1[本地临时目录<br/>/var/lib/soul-echo/uploads]
         G2[阿里云OSS<br/>对象存储]
     end

     subgraph 基础设施层
         H[中间件&工具]
         H1[Flyway<br/>数据库迁移]
         H2[SpringDoc<br/>API文档]
         H3[GlobalExceptionHandler<br/>全局异常处理]
     end

     %% ========== REST API 通信 ========== 

     %% 角色管理API
     A1 -->|HTTPS/REST<br/>获取角色列表| B1_1
     A1 -->|HTTPS/REST<br/>创建/更新角色| B1_1
     A1 -->|HTTPS/REST<br/>角色详情| B1_1
     A1 -->|HTTPS/REST<br/>删除角色| B1_1

     %% 知识库管理API
     A4 -->|HTTPS/Multipart<br/>上传文档| B1_2
     A4 -->|HTTPS/REST<br/>搜索知识库| B1_2
     A4 -->|HTTPS/REST<br/>文档列表| B1_2
     A4 -->|HTTPS/REST<br/>删除文档| B1_2

     %% ========== WebSocket 实时通信 ========== 

     %% 音频流上行
     A3 -->|WebSocket<br/>音频流上行| B2
     A3 -->|WebSocket<br/>JSON文本消息| B2
     A3 -->|WebSocket<br/>心跳检测| B2
     A3 -->|WebSocket<br/>TTS开关切换| B2

     %% 音频流下行
     B2 -->|WebSocket<br/>音频流下行| A3
     B2 -->|WebSocket<br/>LLM文本流| A3
     B2 -->|WebSocket<br/>ASR转写回显| A3

     %% ========== 后端内部调用 ========== 

     B2 --> C1
     C1 --> C2
     C2 -->|CRUD操作| E1_1

     %% 知识库服务调用
     B1_2 --> C3
     C3 -->|发布事件| F1
     F1 -->|触发| F2
     F2 -->|上传文件| G2
     F2 -->|提交索引| D4
     F2 -->|更新状态| E1_3

     C2 -->|知识检索| C3
     C3 -->|RAG检索| D4

     %% ========== AI 服务调用 ========== 

     %% ASR: 语音转文本
     C1 -->|1. 实时语音流<br/>WebSocket协议| D1
     D1 -->|识别结果<br/>含幻觉过滤| C1

     %% LLM: 文本生成（支持RAG）
     C1 -->|2. 用户文本<br/>+角色人设<br/>+知识库上下文| D2
     D2 -->|流式文本生成<br/>SSE流式输出| C1

     %% TTS: 文本转语音
     C1 -->|3. 逐句文本| D3
     D3 -->|流式音频数据<br/>PCM格式| C1

     %% ========== 数据持久化 ========== 

     B1_1 -->|JDBC/Hibernate| E1
     B1_2 -->|JDBC/Hibernate| E1
     C2 -->|JDBC/Hibernate| E1

     %% Redis缓存操作
     C1 -->|分布式锁<br/>保证消息顺序| E2_2
     C1 -->|读取/写入<br/>对话历史| E2_1

     %% ========== 文件存储流程 ========== 

     C3 -->|1. 保存临时文件| G1
     C3 -->|2. 计算MD5| G1
     F2 -->|3. 上传到OSS| G2

     %% ========== 基础设施支持 ========== 

     H1 -.->|数据库版本管理| E1
     H2 -.->|API文档生成| B
     H3 -.->|异常统一处理| B

     %% ========== 样式定义 ========== 
     style A fill:#e1f5ff,stroke:#01579b,stroke-width:2px
     style B fill:#fff4e1,stroke:#ff6f00,stroke-width:2px
     style C fill:#f0e1ff,stroke:#4a148c,stroke-width:2px
     style D fill:#ffe1f0,stroke:#880e4f,stroke-width:2px
     style E fill:#e1ffe1,stroke:#1b5e20,stroke-width:2px
     style F fill:#fff9c4,stroke:#f57f17,stroke-width:2px
     style G fill:#ffccbc,stroke:#bf360c,stroke-width:2px
     style H fill:#cfd8dc,stroke:#37474f,stroke-width:2px

## 2.开发者架构逻辑流
sequenceDiagram
    participant User as 前端 (Vue 3 / Web Audio)
    participant WS as WebSocket Handler
    participant Service as RealtimeChatService
    participant ASR as 阿里云 ASR (Stream)
    participant LLM as 阿里百炼 (Qwen-2.5)
    participant RAG as 向量数据库 (Knowledge)
    participant TTS as 阿里云 TTS (Stream)

    User->>WS: 连接 WebSocket (携带 CharacterID)
    WS->>Service: 初始化 Session
    
    alt 语音输入 (Mode 2/4)
        User->>WS: 持续发送 PCM 音频流 (Uint8Array)
        WS->>ASR: 实时转发音频片段
        ASR-->>WS: 返回中间/最终转写文字 (Incremental Text)
    else 文字输入 (Mode 1/3)
        User->>WS: 发送文本消息 (JSON)
    end

    Service->>RAG: 检索角色背景知识 (Similarity Search)
    RAG-->>Service: 返回 Context
    
    Service->>LLM: 发起流式请求 (System Prompt + Context + Input)
    
    loop 流式响应
        LLM-->>Service: 返回文字 Chunk
        Service->>User: 转发文字 Chunk (显示打字机效果)
        
        Note over Service, TTS: 如果 TTS 开启 (Mode 3/4)
        Service->>TTS: 异步请求文本转语音流
        TTS-->>User: 通过 WS 发送二进制音频帧 (Base64/Binary)
    end

    User->>User: AudioWorklet 实时解码并播放音频

## 3.用户操作流
graph TD
    %% 节点定义
    Start((开始使用))
    Management[角色管理: 增删改查角色]
    Select[选择感兴趣的角色]
    Config{对话模式配置}
    M1[模式1: 文字输入 + 关闭语音]
    M2[模式2: 语音输入 + 关闭语音]
    M3[模式3: 文字输入 + 开启语音]
    M4[模式4: 语音输入 + 开启语音]
    TextOut[仅文字回复]
    AudioOut[文字 + 语音回复]
    KB{加载知识库?}
    RAG[角色根据设定/原著内容回答]
    General[角色根据通用知识回答]
    End((对话持续))
    
    %% 连接关系
    Start --> Management
    Management --> Select
    Select --> Config
    subgraph ModeSelection [四种对话体验]
    Config --> M1
    Config --> M2
    Config --> M3
    Config --> M4
    end
    M1 --> TextOut
    M2 --> TextOut
    M3 --> AudioOut
    M4 --> AudioOut
    Select --> KB
    KB -- 是 --> RAG
    KB -- 否 --> General
    TextOut --> End
    AudioOut --> End

    %% 配色方案
    style Start fill:#81C784,stroke:#388E3C,stroke-width:3px
    style End fill:#64B5F6,stroke:#1565C0,stroke-width:3px
    style Management fill:#FFD54F,stroke:#FFA000,stroke-width:2px,color:#263238
    style Select fill:#FFF176,stroke:#FBC02D,stroke-width:2px,color:#263238
    style Config fill:#CE93D8,stroke:#8E24AA,stroke-width:2px
    style KB fill:#B3E5FC,stroke:#0288D1,stroke-width:2px
    style RAG fill:#FFAB91,stroke:#E64A19,stroke-width:2px
    style General fill:#CFD8DC,stroke:#455A64,stroke-width:2px
    style M1 fill:#D4E157,stroke:#9E9D24,stroke-width:2px
    style M2 fill:#AED581,stroke:#689F38,stroke-width:2px
    style M3 fill:#4FC3F7,stroke:#0288D1,stroke-width:2px
    style M4 fill:#81D4FA,stroke:#0277BD,stroke-width:2px
    style TextOut fill:#EEEEEE,stroke:#616161,stroke-width:1.5px
    style AudioOut fill:#B388FF,stroke:#7C4DFF,stroke-width:2px 

## 4.实时语音对话流程
sequenceDiagram
    participant U as 用户浏览器
    participant W as WebSocket Handler
    participant C as RealtimeChatService
    participant R as Redis（分布式锁）
    participant A as ASR服务
    participant L as LLM服务
    participant T as TTS服务

    U->>W: 发送音频流（二进制）
    W->>C: 转发音频数据
    C->>C: 累积到缓冲区

    Note over C: 检测到1.8秒静默

    C->>R: 获取分布式锁
    R-->>C: 锁获取成功

    C->>A: 提交ASR识别任务
    A-->>C: 异步返回识别结果

    C->>R: 释放锁

    C->>W: 发送用户转写文本
    W->>U: WebSocket推送文本

    C->>L: 提交LLM生成请求
    Note over C,L: 包含：角色人设 + 用户输入 + 历史对话
    L-->>C: 流式返回生成文本

    loop 逐句推送
        C->>W: 推送句子片段
        W->>U: WebSocket实时推送
    end

    alt TTS已启用
        loop 逐句合成
            C->>T: 提交TTS合成
            T-->>C: 流式音频数据
            C->>W: 推送音频块
            W->>U: WebSocket播放音频
        end
    end

    C->>R: 更新对话历史

## 5.知识库上传流程（事件驱动）
sequenceDiagram
    participant U as 用户浏览器
    participant K as KnowledgeController
    participant S as KnowledgeService
    participant E as Spring Event
    participant L as UploadListener
    participant O as 阿里云OSS
    participant B as 百炼知识库
    participant DB as MySQL数据库

    U->>K: POST /api/knowledge/upload（文件）
    K->>S: uploadFile(characterId, file)

    S->>S: 保存到本地临时目录
    S->>S: 计算文件MD5
    S->>DB: 创建记录（状态=UPLOADING）

    S->>E: 发布KnowledgeUploadEvent
    E-->>K: 立即返回（异步处理）
    K-->>U: 返回文档ID

    Note over E: 异步处理开始

    E->>L: 触发监听器onApplicationEvent()
    L->>O: 上传文件到OSS
    O-->>L: 返回阿里云文件ID

    L->>DB: 更新记录（状态=INDEXING）

    L->>B: 提交索引任务
    B-->>L: 返回jobId

    L->>B: 轮询索引状态
    alt 索引成功
        B-->>L: 状态=COMPLETED
        L->>DB: 更新记录（状态=COMPLETED）
    else 索引失败
        B-->>L: 状态=FAILED
        L->>DB: 更新记录（状态=FAILED+错误信息）
    end

## 6.知识库增强对话流程（RAG）
sequenceDiagram
    participant U as 用户
    participant C as CharacterService
    participant K as KnowledgeService
    participant B as 百炼知识库
    participant L as LLM服务

    U->>C: 发送聊天消息
    C->>C: 加载角色信息

    alt 角色关联知识库
        C->>K: searchByCharacterId(characterId, query)
        K->>B: 调用知识检索API
        B-->>K: 返回相关文档片段
        K-->>C: 返回知识上下文
    end

    C->>L: 生成LLM请求
    Note over C,L: 系统提示词 = 角色人设 + 知识库上下文
    L-->>C: 流式生成回复
    C-->>U: 返回增强后的回复

## 7.前端流程图
flowchart TD
    %% ================= 样式定义 =================
    classDef view fill:#e3f2fd,stroke:#1565c0,stroke-width:2px;
    classDef logic fill:#fff3e0,stroke:#ef6c00,stroke-width:2px;
    classDef network fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px;
    classDef hardware fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px;

    %% ================= 开始节点 =================
    Start(["【User】 用户访问首页"]) --> Router{"【Route】 路由分发"}

    %% ================= 模块 1: 角色管理 (基础配置) =================
    subgraph CharModule ["【User】 角色管理模块 (Character Mgmt)"]
        direction TB
        Route -->|/characters| CharView["CharacterManagementView.vue"]
        CharView --> CreateBtn["新建/编辑角色"]
        CreateBtn --> CharForm["表单校验 & 头像上传"]
        CharForm -->|Axios POST| API_Char["后端 API: 保存角色"]
    end

    %% ================= 模块 2: 知识库 (RAG 数据源) =================
    subgraph KBModule ["【Book】 知识库模块 (RAG Knowledge)"]
        direction TB
        Route -->|/knowledge| KBView["KnowledgeBaseView.vue"]
        KBView --> SelectChar_KB["选择关联角色"]
        SelectChar_KB --> UploadBtn["上传文档"]
        UploadBtn -->|File Object| API_KB["后端 API: 触发 Spring Event"]
        API_KB -.->|轮询/WebSocket| KBStatus["更新索引状态: Indexing/Active"]
    end

    %% ================= 模块 3: 核心对话 (Chat Core) =================
    subgraph ChatModule ["【Chat】 沉浸式对话模块 (ChatView)"]
        direction TB
        Route -->|/| MainChat["ChatView.vue"]
        
        %% 3.1 初始化连接
        MainChat --> Sidebar["NavSidebar.vue"]
        Sidebar -->|点击角色| SelectChar_Chat["切换当前会话"]
        SelectChar_Chat -->|触发| WS_Connect["WebSocket 连接握手"]
        
        %% 3.2 消息输入链路
        subgraph InputFlow ["输入流处理"]
            MainChat --> InputComp["ChatInput.vue"]
            InputComp --> InputType{"输入方式?"}
            
            %% 文本路径
            InputType -->|【Text】 文本| TextMsg["构建 JSON 消息"]
            
            %% 语音路径 (亮点)
            InputType -->|【Mic】 语音| MicStream["ModernMicrophoneStreamer.js"]
            MicStream -->|AudioContext| Worklet["【Chip】 Audio Worklet (Processor.js)"]
            Worklet -->|PCM 采样| BinaryStream["二进制音频流"]
        end

        %% 3.3 网络通信
        subgraph NetworkLayer ["通信层"]
            TextMsg -->|send| WSS["【Socket】 websocket.js"]
            BinaryStream -->|stream| WSS
            WSS <==>|ws://| Backend["后端 WebSocket Handler"]
        end

        %% 3.4 响应渲染链路
        subgraph RenderFlow ["响应渲染"]
            Backend -->|OnMessage| MsgHandler["消息分发器"]
            MsgHandler -->|Type: TEXT| Markdown["markdown-it 渲染流式文本"]
            MsgHandler -->|Type: AUDIO| AudioBuffer["AudioStreamPlayer.js"]
            
            Markdown --> UpdateUI["更新 Pinia Store & UI"]
            AudioBuffer -->|Web Audio API| Speaker["【Speaker】 播放合成语音"]
        end
    end

    %% ================= 状态管理 =================
    subgraph Store ["【Database】 Pinia 状态管理"]
        ChatStore["chat.js: 消息队列/连接状态"]
        UserStore["character.js: 角色列表"]
        ToastStore["toast.js: 全局提示"]
    end

    %% 跨模块连接
    API_Char --> UserStore
    WS_Connect --> ChatStore
    MsgHandler --> ChatStore
    KBStatus --> ToastStore

    %% 样式绑定
    class CharView,KBView,MainChat,Sidebar,InputComp view;
    class MicStream,Worklet,AudioBuffer,Markdown,MsgHandler logic;
    class WSS,API_Char,API_KB,Backend network;
    class Speaker hardware;